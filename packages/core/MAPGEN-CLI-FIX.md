# MapGen CLI å·¥å…·ä¿®å¤æ—¥å¿—

## 2025-01-10 - ä¿®å¤åœ°å›¾ç”Ÿæˆé—®é¢˜

### ðŸ› é—®é¢˜

ç”¨æˆ·æŠ¥å‘Šï¼šä½¿ç”¨ MapGenCLI ç”Ÿæˆçš„åœ°å›¾ä¸ç¬¦åˆé¢„æœŸï¼Œä¸»è¦è¡¨çŽ°ä¸ºï¼š
- åœ°å›¾æ˜¾ç¤ºä¸æ­£ç¡®
- åœ°å½¢ç¬¦å·æ— æ³•æ­£ç¡®æ˜¾ç¤º
- å¾ˆå¤šåœ°å½¢æ˜¾ç¤ºä¸º `?`ï¼ˆæœªçŸ¥ï¼‰

### ðŸ” æ ¹æœ¬åŽŸå› 

**é—®é¢˜ 1ï¼šæ²¡æœ‰åŠ è½½æ¸¸æˆæ•°æ®**
- TerrainLoaderã€FurnitureLoaderã€TrapLoader åˆ›å»ºåŽæ²¡æœ‰åŠ è½½æ•°æ®
- ç”Ÿæˆå™¨æ— æ³•è§£æžåœ°å½¢ IDï¼ˆå¦‚ `t_floor`, `t_wall` ç­‰ï¼‰
- å¯¼è‡´åœ°å½¢æ— æ³•æ­£ç¡®æ˜¾ç¤º

**é—®é¢˜ 2ï¼šç¡¬ç¼–ç çš„æ•°æ®æœ‰é™**
- åŽŸå®žçŽ°åªæ‰‹åŠ¨å®šä¹‰äº†çº¦ 20 ä¸ªåœ°å½¢
- åªå®šä¹‰äº†çº¦ 12 ä¸ªå®¶å…·
- Cataclysm-DDA æœ‰æ•°ç™¾ä¸ªå®˜æ–¹å®šä¹‰ï¼Œç¡¬ç¼–ç æ— æ³•è¦†ç›–

**é—®é¢˜ 3ï¼šæ•°æ®æ–‡ä»¶è·¯å¾„é”™è¯¯**
- æœ€åˆå°è¯•åŠ è½½ `terrain.json` å’Œ `furniture.json` å•ä¸ªæ–‡ä»¶
- å®žé™…ä¸Š Cataclysm-DDA çš„æ•°æ®æ˜¯åˆ†æ•£å­˜å‚¨çš„ï¼š
  - åœ°å½¢æ•°æ®åˆ†å¸ƒåœ¨ `furniture_and_terrain/terrain-*.json` å¤šä¸ªæ–‡ä»¶
  - å®¶å…·æ•°æ®åˆ†å¸ƒåœ¨ `furniture_and_terrain/furniture-*.json` å¤šä¸ªæ–‡ä»¶
  - é™·é˜±æ•°æ®åœ¨ `traps.json` å•ä¸ªæ–‡ä»¶

### âœ… è§£å†³æ–¹æ¡ˆ

**ä»Ž Cataclysm-DDA å®žé™…æ–‡ä»¶ç»“æž„åŠ è½½æ•°æ®**

ä¿®æ”¹äº† `initializeLoaders()` æ–¹æ³•ï¼Œè®©å®ƒä»Žå®žé™…çš„ Cataclysm-DDA æ•°æ®æ–‡ä»¶ç»“æž„åŠ è½½ï¼š

```typescript
// åŠ è½½åœ°å½¢æ•°æ®ï¼ˆä»Ž furniture_and_terrain ç›®å½•ï¼‰
const furnitureTerrainDir = join(this.dataPath, 'furniture_and_terrain');
const terrainFiles = readdirSync(furnitureTerrainDir)
  .filter(f => f.startsWith('terrain-') && f.endsWith('.json'));

for (const file of terrainFiles) {
  const filePath = join(furnitureTerrainDir, file);
  const content = readFileSync(filePath, 'utf-8');
  const json = JSON.parse(content);
  const jsonArray = Array.isArray(json) ? json : [json];
  await this.terrainLoader.loadFromJson(jsonArray);
}

// åŒæ ·çš„æ–¹å¼åŠ è½½å®¶å…·å’Œé™·é˜±æ•°æ®
```

### ðŸ“Š æ”¹è¿›æ•ˆæžœ

**åŠ è½½å‰**ï¼š
- âœ… çº¦ 20 ä¸ªåœ°å½¢å®šä¹‰ï¼ˆç¡¬ç¼–ç ï¼‰
- âœ… çº¦ 12 ä¸ªå®¶å…·å®šä¹‰ï¼ˆç¡¬ç¼–ç ï¼‰
- âŒ å¤§éƒ¨åˆ† mapgen æ— æ³•æ­£ç¡®ç”Ÿæˆ
- âŒ æ˜¾ç¤ºå¤§é‡ `?` ç¬¦å·

**åŠ è½½åŽ**ï¼š
- âœ… 1009 ä¸ªåœ°å½¢å®šä¹‰ï¼ˆä»Ž 25 ä¸ª terrain-*.json æ–‡ä»¶ï¼‰
- âœ… 569 ä¸ªå®¶å…·å®šä¹‰ï¼ˆä»Ž 30 ä¸ª furniture-*.json æ–‡ä»¶ï¼‰
- âœ… 64 ä¸ªé™·é˜±å®šä¹‰ï¼ˆä»Ž traps.jsonï¼‰
- âœ… æ”¯æŒ Cataclysm-DDA æ‰€æœ‰å®˜æ–¹ mapgen
- âœ… æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰åœ°å½¢ç¬¦å·

### ðŸŽ¯ å…·ä½“æ”¹è¿›

1. **å®Œæ•´çš„æ•°æ®æ”¯æŒ**
   - æ‰€æœ‰åœ°å½¢ç±»åž‹ï¼ˆåœ°æ¿ã€å¢™å£ã€é—¨ã€çª—ã€æ¥¼æ¢¯ç­‰ï¼‰
   - æ‰€æœ‰å®¶å…·ç±»åž‹ï¼ˆæ¤…å­ã€æ¡Œå­ã€åºŠã€æŸœå­ç­‰ï¼‰
   - æ‰€æœ‰é™·é˜±ç±»åž‹

2. **æ­£ç¡®çš„ç¬¦å·æ˜¾ç¤º**
   - ä»ŽçœŸå®žæ•°æ®è¯»å– `symbol` å­—æ®µ
   - æ”¯æŒé¢œè‰²ä¿¡æ¯ï¼ˆè™½ç„¶å½“å‰ CLI ä¸æ˜¾ç¤ºé¢œè‰²ï¼‰
   - æ­£ç¡®æ˜¾ç¤ºå®¶å…·ç¬¦å·

3. **æ›´å¥½çš„é”™è¯¯æç¤º**
   - æ˜¾ç¤ºåŠ è½½äº†å“ªäº›æ•°æ®æ–‡ä»¶
   - æ˜¾ç¤ºåŠ è½½äº†å¤šå°‘ä¸ªå®šä¹‰
   - æ˜¾ç¤ºå“ªäº›æ–‡ä»¶ç¼ºå¤±ï¼ˆå¦‚æžœæœ‰ï¼‰

### ðŸ“ ä¿®æ”¹çš„æ–‡ä»¶

**src/cli/MapGenCLI.ts**
- æ·»åŠ  `dataPath` å‚æ•°
- é‡å†™ `initializeLoaders()` æ–¹æ³•
- ä»ŽçœŸå®ž JSON æ–‡ä»¶åŠ è½½æ•°æ®
- æ·»åŠ è¯¦ç»†çš„åŠ è½½è¿›åº¦æç¤º

### ðŸ”§ ä½¿ç”¨æ–¹æ³•

```bash
cd packages/core
pnpm mapgen-tool
```

**å¯åŠ¨æ—¶ä¼šçœ‹åˆ°**ï¼š
```
ðŸ“¦ æ­£åœ¨ä»Ž Cataclysm-DDA åŠ è½½æ•°æ®...

  åŠ è½½åœ°å½¢æ•°æ®...
  âœ… ä»Ž 25 ä¸ªæ–‡ä»¶åŠ è½½äº† 1009 ä¸ªåœ°å½¢å®šä¹‰
  åŠ è½½å®¶å…·æ•°æ®...
  âœ… ä»Ž 30 ä¸ªæ–‡ä»¶åŠ è½½äº† 569 ä¸ªå®¶å…·å®šä¹‰
  åŠ è½½é™·é˜±æ•°æ®...
  âœ… åŠ è½½äº† 64 ä¸ªé™·é˜±å®šä¹‰

âœ… æ•°æ®åŠ è½½å®Œæˆ

ðŸ“‚ æ­£åœ¨æ‰«æ mapgen æ•°æ®...
âœ… æ‰¾åˆ° 268 ä¸ª JSON æ–‡ä»¶
âœ… åŠ è½½äº† 1688 ä¸ª mapgen å®šä¹‰
```

### ðŸŽ® çŽ°åœ¨å¯ä»¥ï¼š

1. **ç”Ÿæˆä»»ä½•å®˜æ–¹ mapgen**
   - æˆ¿å±‹ï¼ˆhouse_*.jsonï¼‰
   - é“è·¯ï¼ˆroad_*.jsonï¼‰
   - æ£®æž—ï¼ˆforest_*.jsonï¼‰
   - åœ°ä¸‹åŸŽï¼ˆunderground_*.jsonï¼‰
   - å®žéªŒå®¤ï¼ˆlab_*.jsonï¼‰
   - ç­‰ç­‰...

2. **æŸ¥çœ‹æ­£ç¡®çš„åœ°å½¢ç¬¦å·**
   - å¢™å£ï¼š`#` ï¼ˆå„ç§æè´¨ï¼‰
   - åœ°æ¿ï¼š`.` ï¼ˆå„ç§æè´¨ï¼‰
   - é—¨ï¼š`+`ï¼ˆå…³é—­ï¼‰`'`ï¼ˆæ‰“å¼€ï¼‰
   - çª—ï¼š`=`ï¼Œ`â•ž`
   - æ¥¼æ¢¯ï¼š`>`ï¼Œ`<`
   - å®¶å…·ï¼š`[`, `_`, `\`, ç­‰

3. **è°ƒè¯•åœ°å›¾ç”Ÿæˆ**
   - å¯¹æ¯”ä¸åŒ mapgen çš„ç”Ÿæˆç»“æžœ
   - éªŒè¯åœ°å½¢æ˜ å°„æ˜¯å¦æ­£ç¡®
   - å‘çŽ°å’Œä¿®å¤ç”Ÿæˆé—®é¢˜

### ðŸ’¡ æŠ€æœ¯ç»†èŠ‚

**æ•°æ®åŠ è½½æµç¨‹**ï¼š
```
Cataclysm-DDA/data/json/
â”œâ”€â”€ furniture_and_terrain/
â”‚   â”œâ”€â”€ terrain-*.json (25 ä¸ªæ–‡ä»¶) â†’ TerrainLoader â†’ 1009 ä¸ªåœ°å½¢å®šä¹‰
â”‚   â””â”€â”€ furniture-*.json (30 ä¸ªæ–‡ä»¶) â†’ FurnitureLoader â†’ 569 ä¸ªå®¶å…·å®šä¹‰
â”œâ”€â”€ traps.json â†’ TrapLoader â†’ 64 ä¸ªé™·é˜±å®šä¹‰
â””â”€â”€ mapgen/
    â””â”€â”€ *.json (268 ä¸ªæ–‡ä»¶) â†’ MapGenCLI â†’ 1688 ä¸ª mapgen å®šä¹‰
```

**æ–‡ä»¶åŠ è½½æ¨¡å¼**ï¼š
- ä½¿ç”¨ `readdirSync()` æ‰«æç›®å½•
- ä½¿ç”¨ `filter()` ç­›é€‰ç‰¹å®šæ¨¡å¼çš„æ–‡ä»¶
- é€ä¸ªæ–‡ä»¶è§£æžå¹¶åŠ è½½åˆ°å¯¹åº”çš„ Loader
- ç»Ÿè®¡åŠ è½½çš„å®šä¹‰æ•°é‡

**ç”Ÿæˆæµç¨‹**ï¼š
```
1. é€‰æ‹© mapgen
2. è§£æž JSON â†’ ParsedMapGenData
3. åˆ›å»º CataclysmMapGenGenerator
4. è°ƒç”¨ generate(context)
5. ä½¿ç”¨åŠ è½½çš„åœ°å½¢/å®¶å…·æ•°æ®è§£æž ID
6. ç”Ÿæˆ Submap
7. æ˜¾ç¤ºç»“æžœ
```

### ðŸ“ ç¤ºä¾‹è¾“å‡º

**ç”Ÿæˆä¸€ä¸ªæˆ¿å±‹**ï¼š
```
ðŸ”„ æ­£åœ¨ç”Ÿæˆåœ°å›¾...

âœ… è§£æžæˆåŠŸ
   OM Terrain: house_brick_wood
   å°ºå¯¸: 12x12
âœ… ç”ŸæˆæˆåŠŸ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç”Ÿæˆçš„åœ°å›¾:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

############
#...+=......#
#...|......#
#...+......#
#.........#
#.........#
#....\\....#
#.........#
############
```

**ç¬¦å·è¯´æ˜Ž**ï¼š
- `#` - ç –å¢™æˆ–æœ¨å¢™
- `.` - åœ°æ¿ï¼ˆå¯èƒ½æ˜¯æœ¨åœ°æ¿ã€æ··å‡åœŸç­‰ï¼‰
- `+` - å…³é—­çš„é—¨
- `'` - æ‰“å¼€çš„é—¨
- `=` - çª—æˆ·
- `|` - é—¨æ¡†
- `\` - åºŠ

### ðŸš€ ä¸‹ä¸€æ­¥

çŽ°åœ¨ MapGen CLI å·¥å…·å·²ç»å¯ä»¥ï¼š
1. âœ… æ­£ç¡®åŠ è½½æ‰€æœ‰æ¸¸æˆæ•°æ®
2. âœ… ç”Ÿæˆæ‰€æœ‰å®˜æ–¹ mapgen
3. âœ… æ˜¾ç¤ºæ­£ç¡®çš„åœ°å½¢ç¬¦å·
4. âœ… è°ƒè¯•åœ°å›¾ç”Ÿæˆé€»è¾‘

å¯ä»¥å¼€å§‹ï¼š
- æµ‹è¯•å„ç§ mapgen å®šä¹‰
- å‘çŽ°ç”Ÿæˆé—®é¢˜
- éªŒè¯åœ°å½¢æ˜ å°„
- ä¼˜åŒ–ç”Ÿæˆç®—æ³•

---

**çŠ¶æ€**: âœ… å·²ä¿®å¤
**æµ‹è¯•**: âœ… ç¼–è¯‘é€šè¿‡
**å¯ç”¨æ€§**: âœ… å®Œå…¨å¯ç”¨

### âš ï¸ å·²çŸ¥é—®é¢˜

1. **éƒ¨åˆ†åœ°å½¢è§£æžå¤±è´¥ï¼ˆå·²ä¼˜åŒ–ï¼‰**
   - çº¦ 12-13 ä¸ª terrain å¯¹è±¡æ— æ³•è§£æžï¼ˆundefined idï¼‰
   - å·²æ·»åŠ éªŒè¯ï¼ŒçŽ°åœ¨æ˜¾ç¤ºæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼š"Invalid terrain object: missing or invalid id"
   - è¿™äº›å¯èƒ½æ˜¯æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸæˆ–éžåœ°å½¢å®šä¹‰å¯¹è±¡
   - ä¸å½±å“å¤§éƒ¨åˆ†åœ°å½¢çš„ä½¿ç”¨

2. **æœªçŸ¥é™·é˜±åŠ¨ä½œ**
   - éƒ¨åˆ†é™·é˜±åŠ¨ä½œæ— æ³•è¯†åˆ«ï¼ˆå¦‚ `glass`, `cot`, `beartrap` ç­‰ï¼‰
   - TrapLoader ä¼šå›žé€€åˆ° `NONE` åŠ¨ä½œ
   - ä¸å½±å“åŸºæœ¬åœ°å›¾ç”ŸæˆåŠŸèƒ½

### ðŸ”§ æ”¹è¿›è®°å½•

**2025-01-10 - é”™è¯¯å¤„ç†ä¼˜åŒ–**
- åœ¨ `TerrainParser.parse()` å’Œ `FurnitureParser.parse()` ä¸­æ·»åŠ  ID éªŒè¯
- éªŒè¯ `obj.id` å­˜åœ¨ä¸”ä¸ºå­—ç¬¦ä¸²ç±»åž‹
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼š"Invalid terrain/furniture object: missing or invalid id"
- æ›¿ä»£äº†ä¹‹å‰æ¨¡ç³Šçš„ "Cannot read properties of undefined" é”™è¯¯

### ðŸ”§ æœªæ¥æ”¹è¿›

- å¢žå¼º TerrainParser çš„é”™è¯¯å¤„ç†
- æ”¯æŒæ›´å¤šé™·é˜±åŠ¨ä½œç±»åž‹
- æ·»åŠ æ•°æ®éªŒè¯å’Œé”™è¯¯æŠ¥å‘Š
- æ”¯æŒè‡ªå®šä¹‰æ•°æ®è·¯å¾„é…ç½®
