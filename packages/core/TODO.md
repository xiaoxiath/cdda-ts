# TODO 和未完成系统规划

## 概述

本文档列出了 `@cataclysm-web/core` 与 Cataclysm-DDA C++ 版本之间的功能差距，以及实现这些功能的计划。

## 完成度总览（基于源码级对比分析）

> **重要说明**: 以下完成度基于与 Cataclysm-DDA C++ 源码的严格对比分析，反映了真实的实现差距。

| 系统 | 完成度 | 对比 CDDA | 优先级 | 预估工作量 | 关键缺失 |
|------|--------|-----------|--------|-----------|----------|
| 坐标系统 | ✅ 100% | 完全匹配 | - | - | 无 |
| 地形系统 | ✅ 95% | 基本匹配 | P2 | 1 周 | 部分标志位 |
| 家具系统 | ✅ 95% | 基本匹配 | P2 | 1 周 | 高级特性 |
| 场系统 | ⚠️ 60% | 缺失 40% | P2 | 3 周 | 场融合算法 |
| 陷阱系统 | ✅ 90% | 基本匹配 | P2 | 1 周 | 高级陷阱 |
| 生物系统 | ⚠️ 70% | 缺失 30% | P1 | 4 周 | 身体部位详细化 |
| 地图系统 | ✅ 90% | 基本匹配 | P1 | 2 周 | 高级优化 |
| 地图生成 | ✅ 95% | 基本匹配 | P2 | 1 周 | 部分算法 |
| 游戏循环 | ⚠️ 70% | 缺失 30% | P1 | 3 周 | 调度系统 |
| 大地图系统 | ⚠️ 50% | 缺失 50% | P2 | 4 周 | 城市生成 |
| **效果系统** | ⚠️ 35% | **缺失 65%** | **P0** | **5 周** | **身体部位支持** |
| **物品系统** | ⚠️ 20% | **缺失 80%** | **P0** | **8-10 周** | **容器/弹药/腐烂** |
| **战斗系统** | ❌ 10% | **缺失 90%** | **P0** | **5-6 周** | **完整战斗循环** |
| 技能系统 | ⚠️ 30% | **缺失 70%** | **P1** | **4 周** | **理论/实践双轨** |
| 制作系统 | ⚠️ 25% | **缺失 75%** | **P1** | **5-6 周** | **Proficiency 系统** |
| 装备系统 | ⚠️ 40% | **缺失 60%** | **P1** | **4 周** | **子身体部位** |
| 车辆系统 | ❌ 0% | 缺失 100% | P3 | 6-8 周 | 全部 |
| 天气系统 | ❌ 0% | 缺失 100% | P3 | 3-4 周 | 全部 |
| NPC AI | ⚠️ 20% | 缺失 80% | P1 | 6-8 周 | 行为树系统 |
| 对话系统 | ❌ 0% | 缺失 100% | P2 | 3-4 周 | 全部 |
| 任务系统 | ❌ 0% | 缺失 100% | P3 | 3-4 周 | 全部 |
| 阵营系统 | ❌ 0% | 缺失 100% | P2 | 3 周 | 全部 |

**优先级说明**:
- **P0**: 关键系统，游戏核心循环必需
- **P1**: 重要系统，影响游戏深度
- **P2**: 增强系统，提升游戏体验
- **P3**: 可选系统，可以后期添加

---

## 源码级对比分析结果

> 本节详细列出了各系统与 Cataclysm-DDA C++ 源码的差异分析结果。

### P0-3: 效果系统（完成度: 35%，缺失 65%）

**当前实现**: 基础效果框架、效果定义、效果管理器

**关键缺失功能**:

1. **身体部位支持**（最关键，CDDA 核心特性）
   - [ ] 实现 `Effect::bp_affected` - 受影响的身体部位映射
   - [ ] 实现基于身体部位的效果应用（`effect_on_condition`）
   - [ ] 支持局部效果（如只影响手臂的疼痛）
   - [ ] 身体部位特定效果（如 `bled`, `infected`, `bandaged`）

2. **强度衰减系统**
   - [ ] 实现 `Effect::int_decay` - 强度随时间衰减
   - [ ] 实现强度变化触发器（`int_change_trigger`）
   - [ ] 支持动态强度调整

3. **效果交互系统**
   - [ ] 实现 `Effect::reduces_duration` - 效果间持续时间影响
   - [ ] 实现 `Effect::mods` - 效果修饰符
   - [ ] 实现 `Effect::abs` - 效果抗性
   - [ ] 效果冲突检测和解决

4. **Kill 机制**
   - [ ] 实现 `Effect::kill_msg` - 杀死消息
   - [ ] 实现效果导致的角色死亡处理

5. **维生素效果系统**
   - [ ] 维生素缺乏/过量的效果处理
   - [ ] 动态效果生成

6. **高级修饰符类型**
   - [ ] `STAT_ADD` / `STAT_MULTIPLY` - 属性修饰
   - [ ] `DAMAGE_ADD` / `DAMAGE_MULTIPLY` - 伤害修饰
   - [ ] `SPEED_ADD` / `SPEED_MULTIPLY` - 速度修饰
   - [ ] `ARMOR_ADD` - 护甲修饰

**参考 CDDA 源码**:
- `src/effect.h` - 效果类定义
- `src/effect.cpp` - 效果实现
- `src/player.cpp:effect_*` - 玩家效果应用
- `data/json/effects/*.json` - 效果数据定义

**相关文件位置**:
- CDDA: `src/effect.h` (约 500 行)
- CDDA: `src/effect.cpp` (约 2000 行)
- 本项目: `src/effect/Effect.ts` (约 200 行) - 缺失约 90% 功能

---

### P1-3: 制作系统（完成度: 25%，缺失 75%）

**当前实现**: 基础配方结构、制作管理器

**关键缺失功能**:

1. **Proficiency 系统**（CDDA 最重要特性之一）
   - [ ] 实现 `proficiency` 熟练度要求
   - [ ] 实现熟练度与制作速度/成功率的关系
   - [ ] 实现熟练度学习和提升机制
   - [ ] 支持 `required_proficiency` 配方要求

2. **Quality 要求系统**
   - [ ] 实现 `quality_requirement` 质量要求
   - [ ] 实现物品质量匹配算法
   - [ ] 支持复杂质量条件（`<`, `<=`, `>`, `>=`）

3. **去重材料系统**
   - [ ] 实现使用相同材料类型的配方的去重逻辑
   - [ ] 处理 `deduped_requirement` 语法

4. **批量优化系统**
   - [ ] 实现批量制作优化算法
   - [ ] Logistic 函数计算批量制作时间
   - [ ] 支持最大批次限制

5. **制作助手系统**
   - [ ] 实现物品查找（`item_id` 条件）
   - [ ] 实现模糊匹配和范围匹配

6. **组件过滤器**
   - [ ] 实现 `component_filter` - 限制可用的组件类型
   - [ ] 实现 `blacklist` 和 `whitelist`

7. **蓝图系统**
   - [ ] 实现蓝图保存/加载
   - [ ] 支持蓝图配方
   - [ ] 实现蓝图预览

8. **配方继承和抽象**
   - [ ] 完善 `copy-from` 继承机制
   - [ ] 支持抽象配方（`abstract`）
   - [ ] 支持配方变体

**参考 CDDA 源码**:
- `src/crafting.h` - 制作系统头文件
- `src/crafting.cpp` - 制作系统实现（约 2500 行）
- `src/recipe.cpp` - 配方类实现（约 1800 行）
- `src/proficiency.h/cpp` - 熟练度系统

**相关文件位置**:
- CDDA: `src/crafting.cpp` (约 2500 行)
- CDDA: `src/recipe.cpp` (约 1800 行)
- 本项目: `src/crafting/Recipe.ts` (约 400 行) - 缺失约 75% 功能

---

### P1-1: 技能系统（完成度: 30%，缺失 70%）

**当前实现**: 基础技能定义、技能等级

**关键缺失功能**:

1. **理论/实践双轨系统**（CDDA 核心技能机制）
   - [ ] 实现 `SkillLevel::level()` - 实际技能等级（四舍五入）
   - [ ] 实现 `SkillLevel::theory()` - 理论知识（不四舍五入）
   - [ ] 实现理论到实践的转化机制
   - [ ] 区分学习和训练获得的经验

2. **Proficiency 集成**
   - [ ] 实现技能与熟练度的关联
   - [ ] 熟练度对技能训练的影响
   - [ ] 熟练度解锁机制

3. **完整的生锈系统**
   - [ ] 实现基于时间的技能衰减（`rust_rate`）
   - [ ] 实现不同技能的生锈速率
   - [ ] 实现生锈与记忆的平衡
   - [ ] 支持 `rust_resist` 抗性

4. **书籍学习系统**
   - [ ] 实现书籍技能训练（`book_skill`）
   - [ ] 实现训练上限检查（`required_level`, `max_level`）
   - [ ] 实现阅读时间计算
   - [ ] 实现书籍特殊效果（`fun`, `int`）

5. **上下文技能**
   - [ ] 实现上下文特定技能
   - [ ] 上下文技能的临时加成
   - [ ] 上下文技能的触发条件

6. **Character 集成**
   - [ ] 实现技能与角色的绑定
   - [ ] 技能计算缓存系统
   - [ ] 技能变化通知

**参考 CDDA 源码**:
- `src/skill.h` - 技能系统定义（约 400 行）
- `src/skill.cpp` - 技能实现（约 800 行）
- `src/player.cpp:*_skill` - 玩家技能相关

---

### P1-2: 装备系统（完成度: 40%，缺失 60%）

**当前实现**: 基础装备槽、穿戴逻辑、护甲计算

**关键缺失功能**:

1. **子身体部位系统**（关键特性）
   - [ ] 实现更细粒度的身体部位划分
   - [ ] 支持 `bp_arm_l`, `bp_arm_r`, `bp_leg_l`, `bp_leg_r` 等
   - [ ] 左右不对称装备支持

2. **材料系统**
   - [ ] 实现护甲与材料的关联
   - [ ] 材料抗性系统
   - [ ] 材料厚度计算
   - [ ] 支持材料属性（刚性、柔性等）

3. **潮湿系统**
   - [ ] 实现 `Item::wetness` - 物品潮湿度
   - [ ] 潮湿对保暖值的影响
   - [ ] 潮湿对重量和电导率的影响
   - [ ] 潮湿物品的干燥机制

4. **伤害吸收**
   - [ ] 实现装备伤害吸收（`damage_absorb`）
   - [ ] 装备耐久度系统
   - [ ] 装备破损效果

5. **层冲突检测**
   - [ ] 实现 `covers` 与 `coverage` 的冲突处理
   - [ ] 层叠装备的容量检查
   - [ ] 装备层叠限制

6. **舒适度系统**
   - [ ] 实现装备舒适度计算
   - [ ] 不适装备的效果
   - [ ] 装备风格和偏好

7. **手套/鞋子特殊处理**
   - [ ] 手套对手指操作的影响
   - [ ] 鞋子对移动的影响
   - [ ] 手套/鞋子的开槽系统

**参考 CDDA 源码**:
- `src/worn.h` - 穿戴系统（约 300 行）
- `src/worn.cpp` - 穿戴实现（约 1500 行）
- `src/item.cpp` - 物品相关

---

### P0-1: 物品系统（完成度: 20%，缺失 80%）

**当前实现**: 基础物品类型定义

**关键缺失功能**:

1. **物品容器系统**（最重要特性）
   - [ ] 实现 `ItemPocket` - 物品口袋
   - [ ] 实现 `ItemContents` - 物品内容
   - [ ] 容器嵌套支持
   - [ ] 容器容量和重量限制
   - [ ] 密封容器系统（`watertight`, `airtight`）

2. **腐烂/变质系统**
   - [ ] 实现 `Item::spoilage` - 腐烂计时
   - [ ] 实现食物变质逻辑
   - [ ] 环境温度对腐烂的影响
   - [ ] 容器对腐烂的延缓效果

3. **弹药系统**
   - [ ] 实现 `gun` 类型和枪械属性
   - [ ] 弹药类型和装填逻辑
   - [ ] 弹药消耗和散布
   - [ ] 弹壳生成

4. **物品附魔**
   - [ ] 实现 `Item::enchantments` - 附魔系统
   - [ ] 附魔效果应用
   - [ ] 附魔持久性

5. **物品变体**
   - [ ] 实现 `Item::variant` - 物品变体系统
   - [ ] 变体继承和覆盖
   - [ ] 变体特定属性

6. **物品堆叠**
   - [ ] 实现物品堆叠逻辑
   - [ ] 堆叠合并和分离
   - [ ] 堆叠计数管理

7. **物品使用方法**
   - [ ] 实现 `use_methods` - 多种使用方式
   - [ ] 工具属性检查
   - [ ] 消耗品使用

8. **物品标签和标志**
   - [ ] 实现 `ItemFlag` 系统
   - [ ] 标签查询和匹配
   - [ ] 动态标志添加/移除

**参考 CDDA 源码**:
- `src/item.h` - 物品类定义（约 800 行）
- `src/item.cpp` - 物品实现（约 20000 行）
- `src/item_category.h` - 物品分类

**相关文件位置**:
- CDDA: `src/item.cpp` (约 20000 行)
- 本项目: `src/item/` (约 4300 行) - 缺失约 80% 功能

---

## 第一阶段：核心游戏循环（3-4 个月）

### P0-3: 效果系统增强 🔴

**状态**: 基础框架完成（35%），需大幅扩展
**预估工作量**: 5 周
**依赖**: 生物系统

#### 优先级 P0 - 关键缺失功能

- [ ] **身体部位支持**（最高优先级，核心特性）(1.5 周)
  - [ ] 扩展 Effect 类，添加 `bp_affected: Map<BodyPart, number>`
  - [ ] 实现基于身体部位的效果应用
  - [ ] 支持局部效果（如只影响手臂的疼痛）
  - [ ] 实现 `effect_on_condition` 条件应用
  - [ ] 编写单元测试

- [ ] **强度衰减系统** (1 周)
  - [ ] 实现 `Effect::int_decay` - 强度随时间衰减
  - [ ] 实现强度变化触发器（`int_change_trigger`）
  - [ ] 支持动态强度调整
  - [ ] 编写单元测试

- [ ] **效果交互系统** (1 周)
  - [ ] 实现 `Effect::reduces_duration` - 效果间持续时间影响
  - [ ] 实现 `Effect::mods` - 效果修饰符
  - [ ] 实现 `Effect::abs` - 效果抗性
  - [ ] 效果冲突检测和解决
  - [ ] 编写单元测试

- [ ] **Kill 机制** (0.5 周)
  - [ ] 实现 `Effect::kill_msg` - 杀死消息
  - [ ] 实现效果导致的角色死亡处理
  - [ ] 编写单元测试

- [ ] **高级修饰符类型** (1 周)
  - [ ] `STAT_ADD` / `STAT_MULTIPLY` - 属性修饰
  - [ ] `DAMAGE_ADD` / `DAMAGE_MULTIPLY` - 伤害修饰
  - [ ] `ARMOR_ADD` - 护甲修饰
  - [ ] 维生素效果系统
  - [ ] 编写单元测试

#### 相关文件

- `src/effect/Effect.ts` ✅ (需扩展)
- `src/effect/EffectDefinition.ts` ✅ (需扩展)
- `src/effect/EffectManager.ts` ✅ (需扩展)
- `src/effect/types.ts` ✅ (需添加身体部位相关类型)

---

### P0-1: 物品系统 🔴

**状态**: 基础定义完成（20%），需大幅扩展
**预估工作量**: 8-10 周
**依赖**: 无

#### 优先级 P0 - 关键缺失功能

- [ ] **物品容器系统**（最重要特性）(2 周)
  - [ ] 实现 `ItemPocket` 类 - 物品口袋
  - [ ] 实现 `ItemContents` 类 - 物品内容
  - [ ] 容器嵌套支持
  - [ ] 容器容量和重量限制
  - [ ] 密封容器系统（`watertight`, `airtight`）
  - [ ] 编写单元测试

- [ ] **腐烂/变质系统** (1.5 周)
  - [ ] 实现 `Item::spoilage` - 腐烂计时
  - [ ] 实现食物变质逻辑
  - [ ] 环境温度对腐烂的影响
  - [ ] 容器对腐烂的延缓效果
  - [ ] 编写单元测试

- [ ] **物品栏系统** (1.5 周)
  - [ ] 实现 `Inventory` 类
  - [ ] 实现 `invlet` 分配
  - [ ] 实现物品查询和过滤
  - [ ] 实现容量计算
  - [ ] 编写单元测试

- [ ] **弹药系统** (1.5 周)
  - [ ] 实现 `gun` 类型和枪械属性
  - [ ] 弹药类型和装填逻辑
  - [ ] 弹药消耗和散布
  - [ ] 弹壳生成
  - [ ] 编写单元测试

- [ ] **物品堆叠** (1 周)
  - [ ] 实现物品堆叠逻辑
  - [ ] 堆叠合并和分离
  - [ ] 堆叠计数管理
  - [ ] 编写单元测试

- [ ] **物品使用方法** (1 周)
  - [ ] 实现 `use_methods` - 多种使用方式
  - [ ] 工具属性检查
  - [ ] 消耗品使用
  - [ ] 编写单元测试

- [ ] **物品附魔和变体** (1 周)
  - [ ] 实现 `Item::enchantments` - 附魔系统
  - [ ] 实现 `Item::variant` - 物品变体系统
  - [ ] 编写单元测试

- [ ] **物品加载和文档** (1.5 周)
  - [ ] 实现 `ItemTypeLoader`
  - [ ] 解析 JSON 数据，处理 `copy-from`
  - [ ] 编写 API 文档和使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/item/Item.ts` ✅ (需扩展)
- `src/item/ItemType.ts` ✅
- `src/item/ItemFactory.ts` ✅
- `src/item/ItemPocket.ts` ⏳
- `src/item/ItemContents.ts` ⏳
- `src/item/Inventory.ts` ⏳
- `src/item/ItemLoader.ts` ⏳

---

### P0-2: 战斗系统 🔴

**状态**: 基础框架（10%）
**预估工作量**: 5-6 周
**依赖**: 物品系统、效果系统

#### 子任务

- [ ] **伤害系统** (1.5 周)
  - [ ] 实现 `DamageUnit` 类
  - [ ] 实现 `DamageInstance` 类
  - [ ] 实现 `Resistances` 类
  - [ ] 实现伤害计算（包括身体部位）
  - [ ] 编写单元测试

- [ ] **近战战斗** (1.5 周)
  - [ ] 实现近战攻击系统
  - [ ] 实现命中检定
  - [ ] 实现暴击系统
  - [ ] 实现弱点打击
  - [ ] 编写单元测试

- [ ] **远程战斗** (1.5 周)
  - [ ] 实现抛射物系统
  - [ ] 实现弹道学计算
  - [ ] 实现瞄准系统
  - [ ] 实现散布计算
  - [ ] 编写单元测试

- [ ] **战斗反馈** (0.5 周)
  - [ ] 实现战斗消息系统
  - [ ] 实现伤害数字显示
  - [ ] 实现战斗日志
  - [ ] 编写单元测试

- [ ] **文档和测试** (0.5 周)
  - [ ] 编写 API 文档
  - [ ] 编写使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/combat/DamageUnit.ts` ⏳
- `src/combat/DamageInstance.ts` ⏳
- `src/combat/Resistances.ts` ⏳
- `src/combat/MeleeCombat.ts` ⏳
- `src/combat/RangedCombat.ts` ⏳
- `src/combat/Projectile.ts` ⏳
- `src/combat/Ballistics.ts` ⏳

---

## 第二阶段：游戏深度（3-4 个月）

### P1-3: 制作系统增强 🟡

**状态**: 基础实现完成（25%），需大幅扩展
**预估工作量**: 5-6 周
**依赖**: 物品系统、技能系统、Proficiency 系统

#### 优先级 P1 - 关键缺失功能

- [ ] **Proficiency 系统**（CDDA 最重要特性之一）(2 周)
  - [ ] 实现 `Proficiency` 类和 `ProficiencyLevel`
  - [ ] 实现熟练度学习和提升机制
  - [ ] 熟练度与制作速度/成功率的关系
  - [ ] 支持 `required_proficiency` 配方要求
  - [ ] 编写单元测试

- [ ] **Quality 要求系统** (1 周)
  - [ ] 实现 `quality_requirement` 质量要求
  - [ ] 实现物品质量匹配算法
  - [ ] 支持复杂质量条件（`<`, `<=`, `>`, `>=`）
  - [ ] 编写单元测试

- [ ] **批量优化系统** (1 周)
  - [ ] 实现批量制作优化算法
  - [ ] Logistic 函数计算批量制作时间
  - [ ] 支持最大批次限制
  - [ ] 编写单元测试

- [ ] **高级配方功能** (1 周)
  - [ ] 去重材料系统（`deduped_requirement`）
  - [ ] 制作助手系统（`item_id` 条件）
  - [ ] 组件过滤器（`component_filter`）
  - [ ] 蓝图系统
  - [ ] 编写单元测试

- [ ] **文档和测试** (0.5 周)
  - [ ] 更新 API 文档
  - [ ] 编写使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/crafting/Recipe.ts` ✅ (需扩展)
- `src/crafting/CraftingManager.ts` ✅ (需扩展)
- `src/crafting/Proficiency.ts` ⏳ (新建)
- `src/crafting/QualityRequirement.ts` ⏳ (新建)
- `src/crafting/RecipeLoader.ts` ⏳

---

### P1-1: 技能系统增强 🟡

**状态**: 基础定义完成（30%），需大幅扩展
**预估工作量**: 4 周
**依赖**: 无

#### 优先级 P1 - 关键缺失功能

- [ ] **理论/实践双轨系统**（CDDA 核心技能机制）(1.5 周)
  - [ ] 扩展 `SkillLevel` 类，实现 `level()` 和 `theory()`
  - [ ] 实现理论到实践的转化机制
  - [ ] 区分学习和训练获得的经验
  - [ ] 编写单元测试

- [ ] **完整的生锈系统** (1 周)
  - [ ] 实现基于时间的技能衰减（`rust_rate`）
  - [ ] 不同技能的生锈速率
  - [ ] 生锈与记忆的平衡
  - [ ] 支持 `rust_resist` 抗性
  - [ ] 编写单元测试

- [ ] **书籍学习系统** (1 周)
  - [ ] 实现书籍技能训练（`book_skill`）
  - [ ] 训练上限检查（`required_level`, `max_level`）
  - [ ] 阅读时间计算
  - [ ] 书籍特殊效果（`fun`, `int`）
  - [ ] 编写单元测试

- [ ] **Proficiency 集成** (0.5 周)
  - [ ] 技能与熟练度的关联
  - [ ] 熟练度对技能训练的影响
  - [ ] 熟练度解锁机制

#### 相关文件

- `src/skill/Skill.ts` ✅ (需扩展)
- `src/skill/SkillLevel.ts` ✅ (需大幅扩展)
- `src/skill/SkillLevelMap.ts` ✅
- `src/skill/BookLearning.ts` ⏳ (新建)

---

### P1-2: 装备系统增强 🟡

**状态**: 基础实现完成（40%），需扩展
**预估工作量**: 4 周
**依赖**: 物品系统、生物系统

#### 优先级 P1 - 关键缺失功能

- [ ] **子身体部位系统**（关键特性）(1.5 周)
  - [ ] 扩展身体部位枚举，支持左右区分
  - [ ] 实现 `bp_arm_l`, `bp_arm_r`, `bp_leg_l`, `bp_leg_r` 等
  - [ ] 左右不对称装备支持
  - [ ] 编写单元测试

- [ ] **材料系统** (1 周)
  - [ ] 实现护甲与材料的关联
  - [ ] 材料抗性系统
  - [ ] 材料厚度计算
  - [ ] 支持材料属性（刚性、柔性等）
  - [ ] 编写单元测试

- [ ] **潮湿和耐久系统** (1 周)
  - [ ] 实现 `Item::wetness` - 物品潮湿度
  - [ ] 潮湿对保暖值的影响
  - [ ] 装备伤害吸收（`damage_absorb`）
  - [ ] 装备耐久度系统
  - [ ] 编写单元测试

- [ ] **层冲突和舒适度** (0.5 周)
  - [ ] `covers` 与 `coverage` 的冲突处理
  - [ ] 层叠装备的容量检查
  - [ ] 装备舒适度计算

#### 相关文件

- `src/equipment/Equipment.ts` ✅ (需扩展)
- `src/equipment/EquipmentSlot.ts` ✅ (需扩展)
- `src/equipment/MaterialSystem.ts` ⏳ (新建)
- `src/equipment/Wetness.ts` ⏳ (新建)

---

### P1-4: NPC AI 🟡

**状态**: 基础数据结构（20%）
**预估工作量**: 6-8 周
**依赖**: 战斗系统、技能系统

#### 子任务

- [ ] **行为树系统** (2.5 周)
  - [ ] 实现 BehaviorTree
  - [ ] 实现 BehaviorNode
  - [ ] 实现 Oracle
  - [ ] 实现策略模式
  - [ ] 编写单元测试

- [ ] **NPC 行为** (2 周)
  - [ ] 实现移动 AI
  - [ ] 实现战斗 AI
  - [ ] 实现交互 AI
  - [ ] 实现需求系统
  - [ ] 编写单元测试

- [ ] **路径规划** (1 周)
  - [ ] 实现 A* 寻路
  - [ ] 实现路径缓存
  - [ ] 实现障碍检测
  - [ ] 编写单元测试

- [ ] **文档和测试** (0.5 周)
  - [ ] 编写 API 文档
  - [ ] 编写使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/ai/BehaviorTree.ts`
- `src/ai/BehaviorNode.ts`
- `src/ai/Oracle.ts`
- `src/ai/Pathfinding.ts`
- `src/ai/NPCAI.ts`

---

## 第三阶段：高级功能（2-3 个月）

### P2-1: 大地图系统 🟢

**状态**: 基础结构
**预估工作量**: 3 周
**依赖**: 地图生成系统

#### 子任务

- [ ] **Overmap 结构** (1 周)
  - [ ] 实现 Overmap 类
  - [ ] 实现 OvermapTerrain
  - [ ] 实现城市生成
  - [ ] 编写单元测试

- [ ] **Overmap 生成** (1 周)
  - [ ] 实现地形生成
  - [ ] 实现地点生成
  - [ ] 实现道路连接
  - [ ] 编写单元测试

- [ ] **Overmap 交互** (0.5 周)
  - [ ] 实现玩家移动
  - [ ] 实现区域进入
  - [ ] 实现地图缓冲
  - [ ] 编写单元测试

- [ ] **文档和测试** (0.5 周)
  - [ ] 编写 API 文档
  - [ ] 编写使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/overmap/Overmap.ts`
- `src/overmap/OvermapTerrain.ts`
- `src/overmap/OvermapGenerator.ts`
- `src/overmap/OvermapBuffer.ts`

---

### P2-2: 对话系统 🟢

**状态**: 未开始
**预估工作量**: 2-3 周
**依赖**: NPC AI

#### 子任务

- [ ] **对话框架** (1 周)
  - [ ] 实现 Talker 接口
  - [ ] 实现 Dialogue 类
  - [ ] 实现 TalkTopic
  - [ ] 编写单元测试

- [ ] **对话逻辑** (1 周)
  - [ ] 实现对话试验
  - [ ] 实现对话效果
  - [ ] 实现对话响应
  - [ ] 编写单元测试

- [ ] **对话数据** (0.5 周)
  - [ ] 实现 TalkLoader
  - [ ] 解析对话 JSON
  - [ ] 编写单元测试

- [ ] **文档和测试** (0.5 周)
  - [ ] 编写 API 文档
  - [ ] 编写使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/dialogue/Talker.ts`
- `src/dialogue/Dialogue.ts`
- `src/dialogue/TalkTopic.ts`
- `src/dialogue/TalkTrial.ts`
- `src/dialogue/TalkLoader.ts`

---

### P3-1: 车辆系统 🟢

**状态**: 未开始
**预估工作量**: 4-6 周
**依赖**: 物品系统、地图系统

#### 子任务

- [ ] **车辆结构** (2 周)
  - [ ] 实现 Vehicle 类
  - [ ] 实现 VehiclePart
  - [ ] 实现车辆加载
  - [ ] 编写单元测试

- [ ] **车辆物理** (1.5 周)
  - [ ] 实现车辆移动
  - [ ] 实现碰撞检测
  - [ ] 实现载重系统
  - [ ] 编写单元测试

- [ ] **车辆交互** (1 周)
  - [ ] 实现驾驶
  - [ ] 实现安装/拆卸
  - [ ] 实现加油/充电
  - [ ] 编写单元测试

- [ ] **文档和测试** (1.5 周)
  - [ ] 编写 API 文档
  - [ ] 编写使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/vehicle/Vehicle.ts`
- `src/vehicle/VehiclePart.ts`
- `src/vehicle/VehicleLoader.ts`
- `src/vehicle/VehiclePhysics.ts`

---

### P3-2: 天气系统 🟢

**状态**: 未开始
**预估工作量**: 2-3 周
**依赖**: 无

#### 子任务

- [ ] **天气类型** (0.5 周)
  - [ ] 定义天气类型
  - [ ] 实现 Weather 类
  - [ ] 实现天气加载
  - [ ] 编写单元测试

- [ ] **天气效果** (1 周)
  - [ ] 实现温度计算
  - [ ] 实现降水效果
  - [ ] 实现风力系统
  - [ ] 编写单元测试

- [ ] **季节系统** (0.5 周)
  - [ ] 实现日历系统
  - [ ] 实现季节变化
  - [ ] 实现天气转换
  - [ ] 编写单元测试

- [ ] **文档和测试** (1 周)
  - [ ] 编写 API 文档
  - [ ] 编写使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/weather/Weather.ts`
- `src/weather/WeatherType.ts`
- `src/weather/WeatherLoader.ts`
- `src/weather/Calendar.ts`

---

### P3-3: 任务系统 🟢

**状态**: 未开始
**预估工作量**: 2-3 周
**依赖**: NPC AI、对话系统

#### 子任务

- [ ] **任务结构** (1 周)
  - [ ] 实现 Mission 类
  - [ ] 实现 MissionLoader
  - [ ] 解析任务 JSON
  - [ ] 编写单元测试

- [ ] **任务逻辑** (1 周)
  - [ ] 实现任务分配
  - [ ] 实现任务目标
  - [ ] 实现任务奖励
  - [ ] 编写单元测试

- [ ] **任务 UI** (0.5 周)
  - [ ] 实现任务列表
  - [ ] 实现任务详情
  - [ ] 实现任务追踪
  - [ ] 编写单元测试

- [ ] **文档和测试** (0.5 周)
  - [ ] 编写 API 文档
  - [ ] 编写使用示例
  - [ ] 完善测试覆盖

#### 相关文件

- `src/mission/Mission.ts`
- `src/mission/MissionLoader.ts`
- `src/mission/MissionManager.ts`
- `src/mission/MissionUI.ts`

---

## 增强功能

### P2: 地形系统增强

- [ ] 支持更多地形标志
- [ ] 实现地形转换
- [ ] 优化地形查询性能

### P2: 家具系统增强

- [ ] 支持更多家具标志
- [ ] 实现家具损坏
- [ ] 实现家具修复

### P2: 场系统增强

- [ ] 实现场扩散算法
- [ ] 实现场融合
- [ ] 优化场更新性能

### P2: 陷阱系统增强

- [ ] 支持更多陷阱类型
- [ ] 实现陷阱制作
- [ ] 实现陷阱陷阱

### P1: 生物系统增强

- [ ] 实现身体部位详细伤害
- [ ] 实现属性计算
- [ ] 实现状态效果
- [ ] 实现装备系统

---

## 性能优化

### 内存优化

- [ ] 实现 Submap 池化
- [ ] 优化对象生命周期
- [ ] 减少不必要的拷贝

### 渲染优化

- [ ] 实现脏矩形渲染
- [ ] 优化瓦片缓存
- [ ] 实现层级渲染

### 加载优化

- [ ] 实现懒加载
- [ ] 优化 JSON 解析
- [ ] 实现资源预加载

---

## 工具和开发支持

### CLI 工具

- [ ] 数据验证工具
- [ ] 数据转换工具
- [ ] 性能分析工具
- [ ] 调试工具

### 文档

- [ ] API 参考手册 ✅
- [ ] 架构设计文档 ✅
- [ ] 贡献指南 ✅
- [ ] 部署文档 ✅
- [ ] 故障排除指南 ✅

### 测试

- [ ] 单元测试覆盖率达到 90%+
- [ ] 集成测试覆盖率达到 80%+
- [ ] 端到端测试覆盖率达到 70%+

---

## 时间线（更新于源码对比分析后）

### 2026 Q1 (1-3 月) - 已完成

- ✅ 完成基础系统（坐标、地形、家具、陷阱）
- ✅ 修复编译错误
- ✅ 完成源码级对比分析

### 2026 Q2 (4-6 月) - 进行中

- 🔵 完成效果系统增强（P0-3，5 周）
- 🔵 开始物品系统开发（P0-1，8-10 周）
- 🔵 开始战斗系统开发（P0-2，5-6 周）

### 2026 Q3 (7-9 月)

- 🟢 完成物品系统
- 🟢 完成战斗系统
- 🟢 开始技能系统增强（P1-1，4 周）

### 2026 Q4 (10-12 月)

- 🟢 完成技能系统
- 🟢 完成装备系统增强（P1-2，4 周）
- 🟢 完成制作系统增强（P1-3，5-6 周）
- 🟢 开始 NPC AI（P1-4，6-8 周）

### 2027 Q1-Q2

- 🟢 完成 NPC AI
- 🟢 完成大地图系统（P2-1，4 周）
- 🟢 完成对话系统（P2-2，3-4 周）
- 🟢 性能优化

### 2027 Q3-Q4

- 🟢 完成车辆系统（P3-1，6-8 周）
- 🟢 完成天气系统（P3-2，3-4 周）
- 🟢 完成任务系统（P3-3，3-4 周）
- 🟢 发布 v1.0

---

## 关键发现总结

基于与 Cataclysm-DDA C++ 源码的严格对比分析，发现以下关键问题：

### 🔴 高优先级差距（影响核心游戏循环）

1. **效果系统缺失 65%** - 缺少身体部位支持（CDDA 核心特性）
2. **物品系统缺失 80%** - 缺少容器系统、腐烂系统、弹药系统
3. **战斗系统缺失 90%** - 几乎未实现，需要完整开发

### 🟡 中优先级差距（影响游戏深度）

4. **技能系统缺失 70%** - 缺少理论/实践双轨、完整生锈系统
5. **制作系统缺失 75%** - 缺少 Proficiency 系统（CDDA 最重要特性）
6. **装备系统缺失 60%** - 缺少子身体部位、材料系统

### 📊 代码量对比

| 系统 | CDDA 代码量 | 本项目代码量 | 完成度 |
|------|-----------|-------------|--------|
| 效果 | ~2,500 行 | ~900 行 | 35% |
| 物品 | ~20,000 行 | ~4,300 行 | 20% |
| 技能 | ~1,200 行 | ~350 行 | 30% |
| 制作 | ~4,300 行 | ~1,100 行 | 25% |
| 装备 | ~1,800 行 | ~700 行 | 40% |
| **总计** | **~30,000 行** | **~7,350 行** | **~24%** |

### 🎯 建议优先顺序

基于游戏可玩性分析，建议按以下顺序实现：

1. **效果系统增强** - 身体部位支持是 CDDA 的核心机制
2. **物品系统** - 容器系统和腐烂系统是基础
3. **战斗系统** - 完整战斗循环是游戏核心
4. **制作系统增强** - Proficiency 系统极大增加游戏深度
5. **技能系统增强** - 理论/实践双轨系统
6. **装备系统增强** - 子身体部位和材料系统

### ⏱️ 总工作量估算

- **第一阶段（P0 系统）**: 18-21 周（4.5-5.5 个月）
- **第二阶段（P1 系统）**: 19-22 周（4.5-5.5 个月）
- **第三阶段（P2/P3 系统）**: 15-18 周（3.5-4.5 个月）

**总计**: 约 52-61 周（12-15 个月）达到 CDDA 核心功能对等

---

---

## 图例

- ✅ 已完成
- 🔵 进行中
- 🟢 计划中
- 🟡 部分完成
- ❌ 未开始

---

*本文档会持续更新，反映最新的开发进度和计划。*
